function e(e,n){const t=e.pos,o=e.src.charCodeAt(t);if(n)return!1;if(94!==o)return!1;const s=e.scanDelims(e.pos,!0);let r=s.length;const i=String.fromCharCode(o);if(r<2)return!1;let c;r%2&&(c=e.push("text","",0),c.content=i,r--);for(let n=0;n<r;n+=2)c=e.push("text","",0),c.content=i+i,e.delimiters.push({marker:o,length:0,token:e.tokens.length-1,end:-1,open:s.can_open,close:s.can_close,jump:0});return e.pos+=s.length,!0}function n(e,n){let t;const o=[],s=n.length;for(let r=0;r<s;r++){const s=n[r];if(94!==s.marker)continue;if(-1===s.end)continue;const i=n[s.end];t=e.tokens[s.token],t.type="newthought_open",t.tag="span",t.nesting=1,t.markup="^^",t.content="",t.attrSet("class","newthought"),t=e.tokens[i.token],t.type="newthought_close",t.tag="span",t.nesting=-1,t.markup="^^",t.content="","text"===e.tokens[i.token-1].type&&"^"===e.tokens[i.token-1].content&&o.push(i.token-1)}for(;o.length;){const n=o.pop()||0;let s=n+1;for(;s<e.tokens.length&&"newthought_close"===e.tokens[s].type;)s++;s--,n!==s&&(t=e.tokens[s],e.tokens[s]=e.tokens[n],e.tokens[n]=t)}}function t(e){var t,o;const s=e.tokens_meta,r=e.tokens_meta.length;n(e,e.delimiters);for(let i=0;i<r;i++)(null===(t=s[i])||void 0===t?void 0:t.delimiters)&&n(e,(null===(o=s[i])||void 0===o?void 0:o.delimiters)||[]);return!1}function o(e,n){const{label:t,margin:o}=e[n].meta;return o?`<label for="mn-${t}" class="margin-toggle">&#8853;</label><input id="mn-${t}" type="checkbox" class="margin-toggle">`:`<label for="sn-${t}" class="margin-toggle sidenote-number"></label><input id="sn-${t}" type="checkbox" class="margin-toggle">`}const s=e=>encodeURIComponent(String(e).trim().toLowerCase().replace(/\s+/g,"-"));function r(e){return e.filter((e=>["text","code_inline"].includes(e.type))).map((e=>e.content)).join("")}function i(e){const n=new e.Token("section_open","section",1);n.block=!0;const t=new e.Token("section_close","section",-1);return t.block=!0,{open:n,close:t}}function c(e){var n,t,o;const c={},l=[];if(0!==e.tokens.length){for(let c=e.tokens.length-1;c>=0;c--){const a=e.tokens[c];if("heading_open"===a.type&&"h2"===a.tag){const n=s(r(e.tokens[c+1].children||[])),{open:t,close:o}=i(e),f=new e.Token("heading_open","div",1);f.block=!0,f.attrSet("class","section-link");const u=new e.Token("heading_close","div",-1);u.block=!0;const h=new e.Token("section_anchor_open","a",1);h.attrSet("class","no-tufte-underline");const d=new e.Token("section_anchor_close","a",-1);let p;for(l.unshift({slug:n,anchor:h,target:a}),p=c;p<e.tokens.length;p++){const{type:n,tag:t}=e.tokens[p];if("heading_close"===n&&"h2"===t)break}e.tokens.splice(p+1,0,u),e.tokens.splice(c,0,o,t,f,h,d)}else if("paragraph_open"===a.type){const a=e.tokens[c+1];if("inline"===a.type){const f=null===(n=a.children)||void 0===n?void 0:n[0];if("newthought_open"===(null==f?void 0:f.type)){const{open:n,close:u}=i(e);e.tokens.splice(c,0,u,n);const h=(null===(t=a.children)||void 0===t?void 0:t.slice(1,a.children.findIndex((({type:e})=>"newthought_close"===e))))||[],d=s(r(h)),p=new e.Token("section_anchor_open","a",1);p.attrSet("class","no-tufte-underline");const k=new e.Token("section_anchor_close","a",-1);l.unshift({slug:d,anchor:p,target:f}),null===(o=a.children)||void 0===o||o.splice(1,0,p,k)}}}}for(const e of l){const n=e.slug;let t=n,o=0;for(;c[t];)t=`${n}-${++o}`;c[t]=!0,e.anchor.attrSet("href",`#${t}`),e.target.attrSet("id",t)}if("section_close"===e.tokens[0].type)e.tokens.push(e.tokens.shift());else{const{open:n,close:t}=i(e);e.tokens.unshift(n),e.tokens.push(t)}}}function l(n){!function(n){n.inline.ruler.after("emphasis","newthought",e),n.inline.ruler2.after("emphasis","newthought",t)}(n),function(e){e.renderer.rules.sidenote_ref=o,e.renderer.rules.margin_marker=e.renderer.rules.text;const n=/^\{-\}\s*/;e.block.ruler.before("reference","footnote_def",(function(n,t,o,s){var r;const i=n.bMarks[t]+n.tShift[t],c=n.eMarks[t];if(i+4>c)return!1;if(91!==n.src.charCodeAt(i))return!1;if(94!==n.src.charCodeAt(i+1))return!1;let l;for(l=i+2;l<c;l++){if(32===n.src.charCodeAt(l))return!1;if(93===n.src.charCodeAt(l))break}if(l===i+2)return!1;if(l+1>=c||58!==n.src.charCodeAt(++l))return!1;if(s)return!0;l++,n.env.footnotes||(n.env.footnotes={}),n.env.footnotes.defs||(n.env.footnotes.defs={});const a=n.src.slice(i+2,l-2),f=n.bMarks[t],u=n.tShift[t],h=n.sCount[t],d=n.tokens.length,p=l,k=n.sCount[t]+l-(n.bMarks[t]+n.tShift[t]);let g=k;for(;l<c;){const t=n.src.charCodeAt(l);if(!e.utils.isSpace(t))break;9===t?g+=4-g%4:g++,l++}n.tShift[t]=l-p,n.sCount[t]=g-k,n.bMarks[t]=p,n.blkIndent+=4,n.sCount[t]<n.blkIndent&&(n.sCount[t]+=n.blkIndent),n.md.block.tokenize(n,t,o);const m=n.tokens.splice(d-n.tokens.length);let _=!1;for(let e=m.length-1;e>=0;e--){const t=m[e];if("p"===t.tag){const o=_&&"paragraph_close"===t.type?[new n.Token("hardbreak","br",0)]:[];m.splice(e,1,...o)}_="paragraph_open"===t.type,"inline"===t.type&&(t.children||(t.children=[]),n.md.inline.parse(t.content,n.md,n.env,t.children))}let b=!1;return"margin_marker"===(null===(r=m[0].children)||void 0===r?void 0:r[0].type)&&(b=!0,m[0].children.shift()),n.env.footnotes.defs[`:${a}`]={tokens:m,margin:b},n.blkIndent-=4,n.tShift[t]=u,n.sCount[t]=h,n.bMarks[t]=f,!0})),e.inline.ruler.after("image","footnote_ref",(function(e,n){const t=e.posMax,o=e.pos;if(o+3>t)return!1;if(!e.env.footnotes||!e.env.footnotes.defs)return!1;if(91!==e.src.charCodeAt(o))return!1;if(94!==e.src.charCodeAt(o+1))return!1;let s;for(s=o+2;s<t;s++){if(32===e.src.charCodeAt(s))return!1;if(10===e.src.charCodeAt(s))return!1;if(93===e.src.charCodeAt(s))break}if(s===o+2)return!1;if(s>=t)return!1;s++;const r=e.src.slice(o+2,s-1);if(void 0===e.env.footnotes.defs[`:${r}`])return!1;if(!n){const n=e.push("sidenote_ref","",0),{tokens:t,margin:o}=e.env.footnotes.defs[`:${r}`];n.meta={blocks:t,label:r,margin:o}}return e.pos=s,!0})),e.inline.ruler.after("footnote_ref","footnote_ref_inline",(function(n,t){const o=n.posMax,s=n.pos;if(s+3>o)return!1;if(94!==n.src.charCodeAt(s))return!1;if(91!==n.src.charCodeAt(s+1))return!1;const r=s+2,i=e.helpers.parseLinkLabel(n,s+1);if(i<0)return!1;if(!t){n.env.footnotes||(n.env.footnotes={}),n.env.footnotes.defs||(n.env.footnotes.defs={});const e=Object.keys(n.env.footnotes.defs).length,t=new n.Token("inline","",0);t.content=n.src.slice(r,i).trim(),t.children=[];const o=[t];n.md.inline.parse(t.content,n.md,n.env,t.children);const s="margin_marker"===t.children[0].type;s&&t.children.shift(),n.env.footnotes.defs[`:${e}`]={tokens:o,margin:s},n.push("sidenote_ref","",0).meta={blocks:o,label:e,margin:s}}return n.pos=i+1,!0})),e.inline.ruler.after("footnote_ref_inline","margin_marker",(function(e,t){const o=e.src.slice(e.pos).match(n);return!!o&&(t||(e.push("margin_marker","",0).content=o[0]),e.pos+=o[0].length,!0)})),e.core.ruler.after("inline","footnote_tail",(function(e){const{tokens:n}=e;for(let t=n.length-1;t>=0;t--){const o=n[t];if("inline"===o.type&&o.children){const s=[];let r;for(;(r=o.children.findIndex((e=>"sidenote_ref"===e.type)))>0;){const n=o.children[r],{blocks:t,margin:i}=n.meta,c=new e.Token("inline","",0);c.children=o.children.splice(0,r+1);const l=new e.Token("span_open","span",1);l.attrSet("class",i?"marginnote":"sidenote"),s.push(c),s.push(l),s.push(...t),s.push(new e.Token("span_close","span",-1))}s.push(o),s.length>1&&n.splice(t,1,...s)}}}))}(n),function(e){e.core.ruler.push("sectionize",c)}(n),function(e){e.core.ruler.after("linkify","figure",(e=>{var n,t,o,s,r,i;for(let c=e.tokens.length-1;c>=0;c--){const l=e.tokens[c];if("inline"!==l.type)continue;if(1!==(null===(n=l.children)||void 0===n?void 0:n.length))continue;if("image"!==l.children[0].type)continue;if("paragraph_close"!==e.tokens[c+1].type)continue;if("paragraph_open"!==e.tokens[c-1].type)continue;e.tokens[c+1]=new e.Token("figure_close","figure",-1),e.tokens[c+1].block=!0,e.tokens[c-1]=new e.Token("figure_open","figure",1),e.tokens[c-1].block=!0,e.tokens[c-1].attrs=(null===(t=l.children[0].attrs)||void 0===t?void 0:t.filter((([e])=>!["src","alt","title"].includes(e))))||null,l.children[0].attrs=(null===(o=l.children[0].attrs)||void 0===o?void 0:o.filter((([e])=>["src","alt","title"].includes(e))))||null;const a=l.children[0],f=a.attrGet("title");if(!f)continue;const u=new e.Token("inline","",0);u.content=f,u.block=!0;const h=new e.Token("text","",0);h.content=f,u.children=[h];const d=new e.Token("figcaption_open","figcaption",1);d.block=!0;const p=new e.Token("figcaption_close","figcaption",-1);p.block=!0,e.tokens=(s=e.tokens,r=c,i=[a,d,u,p],[].concat(s.slice(0,r),i,s.slice(r+1)))}}))}(n)}export{l as default};
//# sourceMappingURL=index.esm.min.js.map
